---
title: "Investigate officers who do not have a work assignment"
format: pdf
---

```{r, include = F}
library(here)
library(readr)
library(dplyr)
library(knitr)
library(ggplot2)
library(stringr)
opts_chunk$set(message = F, echo = F, warning = F)
input_path <- paste("create_officer_assignments", "input", sep = "/")
output_path <- paste("create_officer_assignments", "output", sep = "/")
```

```{r}
# Read in police officer roster.
officers <- 
    read_csv(
        here(input_path, "officers.csv.gz"),
        col_types = 
            cols_only(
                birth_year = "d",
                appointed_month = col_date(format = "%Y-%m-%d"),
                officer_id = "c",
                officer_race = "c",
                officer_gender = "c",
                spanish = "l"
            )
    ) %>%
    rename(officer_sex = officer_gender) %>%
    mutate(
        officer_race = str_replace(officer_race, "officer_", ""),
        officer_race = 
            case_when(
                officer_race == "aapi" ~ "aapi_native",
                officer_race == "native" ~ "aapi_native",
                T ~ officer_race
            )
    )
    
# Read in merged officer-work assignments.
officer_assignments_risi <-
    read_csv(
        here(output_path, "officer_assignments_risi.csv.gz"),
        col_types =
            cols_only(
                officer_id = "c",
                month = col_date(format = "%Y-%m-%d"),
                rank = "c",
                unit = "c",
                date = col_date(format = "%Y-%m-%d"),
                shift = "c",
                start_time = "d",
                end_time = "d",
                weekday = "c",
                beat_assigned = "c",
                months_from_start = "d",
                months_from_start_sq = "d",
                duration = "d",
                row_id = "c",
                mdsb_id = "c",
                work_assignment_id = "c",
                work_assignment_no_unit_id = "c",
                start_datetime = col_datetime(format = ""),
                end_datetime = col_datetime(format = ""),
                birth_year = "d",
                appointed_month = col_date(format = "%Y-%m-%d"),
                officer_race = "c",
                officer_sex = "c",
                spanish = "l"
            )
    )
```

```{r, results = "asis"}
officers <-
    officers %>%
    mutate(
        has_a_shift = 
            if_else(
                officer_id %in% officer_assignments_risi$officer_id,
                T,
                F
            )
    )

ggplot(officers, aes(x = birth_year)) +
    geom_histogram(bins = 40, aes(fill = has_a_shift)) +
    facet_wrap(~has_a_shift) +
    theme_bw()

officers %>%
    count(officer_race, has_a_shift) %>%
    group_by(has_a_shift) %>%
    mutate(prcnt = n / sum(n)) %>%
    ungroup() %>%
    ggplot(aes(x = officer_race, y = prcnt)) +
    geom_bar(stat = "identity", aes(fill = has_a_shift)) +
    facet_wrap(~has_a_shift) +
    theme_bw() +
    theme(axis.text.x = element_text(hjust = 0, angle = 330))

officers %>%
    count(officer_sex, has_a_shift) %>%
    group_by(has_a_shift) %>%
    mutate(prcnt = n / sum(n)) %>%
    ungroup() %>%
    ggplot(aes(x = officer_sex, y = prcnt)) +
    geom_bar(stat = "identity", aes(fill = has_a_shift)) +
    facet_wrap(~has_a_shift) +
    theme_bw()

officers %>%
    count(spanish, has_a_shift) %>%
    group_by(has_a_shift) %>%
    mutate(prcnt = n / sum(n)) %>%
    ungroup() %>%
    ggplot(aes(x = spanish, y = prcnt)) +
    geom_bar(stat = "identity", aes(fill = has_a_shift)) +
    facet_wrap(~has_a_shift) +
    theme_bw()
```

Officers who have a work assignment appear to be, generally, younger and more racially and sexually diverse than officers who do not have a work assignment. This supports the idea that at least some (if not many) of the officers who do not have a work assignment are likely retired (they would be older and more likely to be White and Male). Some of the officers listed in the roster likely do not get assigned work assignments of the kind we have data on (e.g., they are in a leadership role, or they're in a special unit or on a special task force). More worrisome might be officers who don't get shift assignments for some other, unknown reason which might hurt the validity of the study (e.g. they're being punished or rewarded). By merging with the Invisible Institute data, we might be able to shed more light on this issue.
