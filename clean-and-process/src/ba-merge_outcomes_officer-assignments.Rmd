---
title: "Replicate Ba et al. 2021 - Merging Stops, Arrests, and Uses of Force to Officer Assignments"
output: pdf_document
---

```{r, include = F}
library(knitr)
opts_chunk$set(message = F, echo = F, warning = F)

library(here)
source(here("functions.R"))

# Read in data
path <- paste("clean-and-process", "output", sep = "/")
officer_assignments <- my_read_csv(here(path, "officers_assignments_ba.csv"))
stops <- my_read_csv(here(path, "cleaned-stops.csv"))
arrests <- my_read_csv(here(path, "cleaned-arrests.csv"))
force <- my_read_csv(here(path, "cleaned-force.csv"))

# convert to data.table
setDT(officer_assignments)
setDT(stops)
setDT(arrests)
setDT(force)
```

```{r}
# Match stops to the shift assignments they occurred during
stops_merged <- ba_merge(officer_assignments, stops, stop_officer_id)
missing_times_stops <- stops_merged %>% find_missing(stop_officer_id)
duplicate_stops <- stops_merged %>% find_dupes(stop_officer_id)
pretty_print_stops <- PrettyPrint(stops_merged, stops, officer_assignments,
                                  missing_times_stops, duplicate_stops,
                                  "stop_officer_id")
write_csv(stops_merged, here(path, "stops_officers_assignments_ba_max.csv"))

# Match arrests to the shift assignments they occurred during
arrests_merged <- ba_merge(officer_assignments, arrests, arrest_officer_id)
missing_times_arrests <- arrests_merged %>% find_missing(arrest_officer_id)
duplicate_arrests <- arrests_merged %>% find_dupes(arrest_officer_id)
pretty_print_arrests <- PrettyPrint(arrests_merged, arrests, officer_assignments,
                                    missing_times_arrests, duplicate_arrests,
                                    "arrest_officer_id")
write_csv(arrests_merged, here(path, "arrests_officers_assignments_ba_max.csv"))

# Match uses of force to the shift assignments they occurred during
force_merged <- ba_merge(officer_assignments, force, force_id)
missing_times_force <- force_merged %>% find_missing(force_id)
duplicate_force <- force_merged %>% find_dupes(force_id)
pretty_print_force <- PrettyPrint(force_merged, force, officer_assignments,
                                  missing_times_force, duplicate_force,
                                  "force_id")
write_csv(force_merged, here(path, "force_officers_assignments_ba_max.csv"))

rm(stops_merged, arrests_merged, force_merged)
```

## Merge process - Ba et al. 2021

> "For stops, arrests, and uses of force, we drop all events that occur outside of the reported patrol start/stop times, eliminating off-duty activity." page 8 of Appendix Section S1.5 in Ba et al. 2021.

1. Right join the outcome (i.e. stops, arrests, or uses of force) and officer assignments using officer_id and date. I.e. keep every assignment and only outcomes which occurred during the start date of the shift.
2. Keep any outcomes which occurred during the hours of the shift.
    * Round the outcome time to the lowest hour.
    * Round the shift start time to the lowest hour.
    * Round the shift end time to the highest hour.
3. Right join outcomes and assignments using officer_id and date (incremented by one day). This captures outcomes which occurred the **following day** during an overnight shift.
4. Keep any outcomes which occurred during the hours of the shift using the same logic as in step 2.
5. Merge the data sets (outcomes merged by date and outcomes merged by the next day) by row. 
    * Keep only distinct entries. Shift assignments which had no outcomes will have duplicate entries since they will appear as having had no outcomes on the focal day **and** the next day (since we also check the next day due to overnight shifts).
    * Filter out any shift assignments which matched with outcomes on one date but not the other. For example, a non-overnight shift will obviously not match with any outcomes the following day. As a result, there will be an entry for that shift assignment with no outcomes associated with it. However, there will be other entries for that shift assignment with correctly matched outcomes. As a result, the shift assignment entry in question will be erroneous.
    
**Notes**

* It will occasionally be the case that an outcome will match to multiple shift assignments. How can an outcome match to more than one shift assignment?
    * The officer in question could have had overlapping shift assignments, and the outcome occurred during the intersection of their shifts.
    * One of the shifts had a missing start time or end time, and the outcome matched with that shift (in addition to matching with at least one another shift assignment).
* It will occasionally be the case that not all shift assignments are retained in the merging process despite using a right join. Why aren't all shift assignments retained? Ba et al. (2021) have it so that any shift assignment which had an outcome on the same day **but** did not occur during the shift itself is counted as missing and not retained.
* Ba et al. (2021) implicitly assume that if an outcome and a shift assignment match on the **date** but the shift assignment is missing its **start time and end time** then the outcome **should still** match that shift assignment.

### Merge stops - Ba et al. 2021

* **Number of resulting rows**: `r pretty_print_stops$nrow`
* **Number of stops which occurred during a shift**: `r pretty_print_stops$nr_outcome`
    * **Percentage of stops** (`r nrow(stops)`): `r pretty_print_stops$prcnt_outcome`%
* **Number of shift assignments retained:** `r pretty_print_stops$nr_shift`
    * **Percentage of shift assignments**: `r pretty_print_stops$prcnt_shift`%
* `r pretty_print_stops$nr_missing_shifts` shift assignments matched with at least one stop **without having** a start time and an end time.
    * This represents `r pretty_print_stops$prcnt_missing_shifts`% of all shift assignments.
    * `r pretty_print_stops$nr_missing_outcomes` stops are affected or `r pretty_print_stops$prcnt_missing_outcomes`% of all stops.
* There are `r pretty_print_stops$nr_dupe_outcomes` stops which match to more than one shift assignment.
    * These **duplicate** stops represent `r pretty_print_stops$prcnt_dupe_outcomes`% of all stops (`r nrow(stops)`).
    * `r pretty_print_stops$nr_dupe_shifts` shift assignments are affected or `r pretty_print_stops$prcnt_dupe_shifts`% of all shift assignments.
    * In total, there are `r pretty_print_stops$nr_dupes` **duplicate stop-shift observations** representing `r pretty_print_stops$prcnt_dupes`% of all stop-shift observations.

### Merge arrests - Ba et al. 2021

* **Number of resulting rows**: `r pretty_print_arrests$nrow`
* **Number of arrests which occurred during a shift**: `r pretty_print_arrests$nr_outcome`
    * **Percentage of arrests** (`r nrow(arrests)`): `r pretty_print_arrests$prcnt_outcome`%
* **Number of shift assignments retained:** `r pretty_print_arrests$nr_shift`
    * **Percentage of shift assignments**: `r pretty_print_arrests$prcnt_shift`%
* `r pretty_print_arrests$nr_missing_shifts` shift assignments matched with at least one arrest **without having** a start time and an end time.
    * This represents `r pretty_print_arrests$prcnt_missing_shifts`% of all shift assignments.
    * `r pretty_print_arrests$nr_missing_outcomes` arrests are affected or `r pretty_print_arrests$prcnt_missing_outcomes`% of all arrests.
* There are `r pretty_print_arrests$nr_dupe_outcomes` arrests which match to more than one shift assignment.
    * These **duplicate** arrests represent `r pretty_print_arrests$prcnt_dupe_outcomes`% of all arrests (`r nrow(arrests)`).
    * `r pretty_print_arrests$nr_dupe_shifts` shift assignments are affected or `r pretty_print_arrests$prcnt_dupe_shifts`% of all shift assignments.
    * In total, there are `r pretty_print_arrests$nr_dupes` **duplicate stop-shift observations** representing `r pretty_print_arrests$prcnt_dupes`% of all arrest-shift observations.

### Merge uses of force - Ba et al. 2021

* **Number of resulting rows**: `r pretty_print_force$nrow`
* **Number of uses of force which occurred during a shift**: `r pretty_print_force$nr_outcome`
    * **Percentage of uses of force** (`r nrow(force)`): `r pretty_print_force$prcnt_outcome`%
* **Number of shift assignments retained:** `r pretty_print_force$nr_shift`
    * **Percentage of shift assignments**: `r pretty_print_force$prcnt_shift`%
* `r pretty_print_force$nr_missing_shifts` shift assignments matched with at least one use of force **without having** a start time and an end time.
    * This represents `r pretty_print_force$prcnt_missing_shifts`% of all shift assignments.
    * `r pretty_print_force$nr_missing_outcomes` uses of force are affected or `r pretty_print_force$prcnt_missing_outcomes`% of all uses of force.
* There are `r pretty_print_force$nr_dupe_outcomes` uses of force which match to more than one shift assignment.
    * These **duplicate** uses of force represent `r pretty_print_force$prcnt_dupe_outcomes`% of all uses of force (`r nrow(force)`).
    * `r pretty_print_force$nr_dupe_shifts` shift assignments are affected or `r pretty_print_force$prcnt_dupe_shifts`% of all shift assignments.
    * In total, there are `r pretty_print_force$nr_dupes` **duplicate stop-shift observations** representing `r pretty_print_force$prcnt_dupes`% of all force-shift observations.

```{r}
# Drop these columns as they are redundant
stops <- stops %>% select(-date, -month)
force <- force %>% select(-date, -month)

# Arrests don't have a time associated with them. Only the hour they occurred.
arrests <-
    arrests %>%
    mutate(time = as_datetime(paste0(date,
                                     " ",
                                     hms::hms(rep(0, nrow(arrests)),
                                              rep(0, nrow(arrests)),
                                              hour)))) %>%
    select(-date, -month)

# Right non-equi join stops to officer assignments
stops_shift_assignments <-
    stops[officer_assignments,
          on = .(officer_id, time >= start_datetime, time <= end_datetime)] %>%
    rename(start_datetime = time, end_datetime = time.1) %>%
    left_join(select(stops, time, stop_officer_id), by = "stop_officer_id")

# Right non-equi join arrests to officer assignments
arrests_shift_assignments <-
    arrests[officer_assignments,
            on = .(officer_id, time >= start_datetime, time <= end_datetime)] %>%
    rename(start_datetime = time, end_datetime = time.1) %>%
    left_join(select(arrests, time, arrest_officer_id), by = "arrest_officer_id")

# Right non-equi joins force to officer assignments
force_shift_assignments <-
    force[officer_assignments,
          on = .(officer_id, time >= start_datetime, time <= end_datetime)] %>%
    rename(start_datetime = time, end_datetime = time.1) %>%
    left_join(select(force, time, force_id), by = "force_id")

# Find outcomes with matched with shift assignments that have a missing start and end time
# In theory there should be 0
missing_stops_risi <- stops_shift_assignments %>% find_missing(stop_officer_id)
missing_arrests_risi <- arrests_shift_assignments %>% find_missing(arrest_officer_id)
missing_force_risi <- force_shift_assignments %>% find_missing(force_id)

# Find outcomes which matched with multiple shifts
duplicate_stops_risi <- stops_shift_assignments %>% find_dupes(stop_officer_id)
duplicate_arrests_risi <- arrests_shift_assignments %>% find_dupes(arrest_officer_id)
duplicate_force_risi <- force_shift_assignments %>% find_dupes(force_id)

# Pretty print the results
ppsjr <-
    PrettyPrint(stops_shift_assignments, stops, officer_assignments,
                missing_stops_risi, duplicate_stops_risi, "stop_officer_id")
ppajr <-
    PrettyPrint(arrests_shift_assignments, arrests, officer_assignments,
                missing_arrests_risi, duplicate_arrests_risi, "arrest_officer_id")
ppfjr <-
    PrettyPrint(force_shift_assignments, force, officer_assignments,
                missing_force_risi, duplicate_force_risi, "force_id")

# Remove duplicates
stops_shift_assignments <-
    stops_shift_assignments %>%
    group_by(stop_officer_id) %>%
    filter(is.na(stop_officer_id) | n() <= 1) %>%
    ungroup()

arrests_shift_assignments <-
    arrests_shift_assignments %>%
    group_by(arrest_officer_id) %>%
    filter(is.na(arrest_officer_id) | n() <= 1) %>%
    ungroup()

force_shift_assignments <-
    force_shift_assignments %>%
    group_by(force_id) %>%
    filter(is.na(force_id) | n() <= 1) %>%
    ungroup()

# Write out results
write_csv(stops_shift_assignments,
          here(path, "stops_officers_assignments_ba_min.csv"))

write_csv(arrests_shift_assignments,
          here(path, "arrests_officers_assignments_ba_min.csv"))

write_csv(force_shift_assignments,
          here(path, "force_officers_assignments_ba_min.csv"))
```

## Merge process - Risi

1. Conduct a right non-equi join on stops and officer assignments using officer_id, time of the stop, the start time of the shift, and the end time of the shift. I.e. Keep every shift assignment and keep those stops which occurred exactly between the start time and end time for a particular shift.
2. **Differences from Ba et al. 2021**
    * Any shift with a missing start time and end time will not match with any stops. Ba et al. 2021 will match a shift with a missing start time and end time with any stop that occurred on the same day(s) as the shift.
    * The stop must have occurred exactly between the start time and end time of the shift. Ba et al. 2021 use rounding to create a window of time around the shift start and end times in which a stop may have occurred and would still count as happening during the shift.
    * If a shift assignment has a stop which occurs the same day, but the stop does not occur during the shift times, the shift is recorded as having no stops rather being recorded as *missing*.
    * Any stops which are matched to multiple shift assignment are dropped. **All duplicate entries** are dropped.

### Merge stops - Risi

* **Number of resulting rows**: `r ppsjr$nrow`
* **Number of stops which occurred during a shift**: `r ppsjr$nr_outcome`
    * **Percentage of stops** (`r nrow(stops)`): `r ppsjr$prcnt_outcome`%
    * **Number of fewer stops matched than Ba et al. 2021**: `r pretty_print_stops$nr_outcome - ppsjr$nr_outcome`
    * **Percent reduction from Ba et al. 2021**: `r (pretty_print_stops$nr_outcome - ppsjr$nr_outcome) / pretty_print_stops$nr_outcome * 100`%
* **Number of shift assignments retained:** `r ppsjr$nr_shift`
    * **Percentage of shift assignments**: `r ppsjr$prcnt_shift`% **NOTE** this should be 100%.
* `r ppsjr$nr_missing_shifts` shift assignments matched with at least one stop **without having** a start time and an end time. **NOTE** that this should be 0.
* There are `r ppsjr$nr_dupe_outcomes` stops which match to more than one shift assignment.
    * These **duplicate** stops represent `r ppsjr$prcnt_dupe_outcomes`% of all stops (`r nrow(stops)`).
    * `r ppsjr$nr_dupe_shifts` shift assignments are affected or `r ppsjr$prcnt_dupe_shifts`% of all shift assignments.
    * In total, there are `r ppsjr$nr_dupes` **duplicate stop-shift observations** representing `r ppsjr$prcnt_dupes`% of all stop-shift observations.
    * As noted above, **all these entries are dropped**.

### Merge arrests - Risi

* **Number of resulting arrests**: `r ppajr$nrow`
* **Number of arrests which occurred during a shift**: `r ppajr$nr_outcome`
    * **Percentage of arrests** (`r nrow(arrests)`): `r ppajr$prcnt_outcome`%
    * **Number of fewer arrests matched than Ba et al. 2021**: `r pretty_print_arrests$nr_outcome - ppajr$nr_outcome`
    * **Percent reduction from Ba et al. 2021**: `r (pretty_print_arrests$nr_outcome - ppajr$nr_outcome) / pretty_print_arrests$nr_outcome * 100`%
* **Number of shift assignments retained:** `r ppajr$nr_shift`
    * **Percentage of shift assignments**: `r ppajr$prcnt_shift`% **NOTE** this should be 100%.
* `r ppajr$nr_missing_shifts` shift assignments matched with at least one arrest **without having** a start time and an end time. **NOTE** that this should be 0.
* There are `r ppajr$nr_dupe_outcomes` arrests which match to more than one shift assignment.
    * These **duplicate** arrests represent `r ppajr$prcnt_dupe_outcomes`% of all arrests (`r nrow(arrests)`).
    * `r ppajr$nr_dupe_shifts` shift assignments are affected or `r ppajr$prcnt_dupe_shifts`% of all shift assignments.
    * In total, there are `r ppajr$nr_dupes` **duplicate arrest-shift observations** representing `r ppajr$prcnt_dupes`% of all arrest-shift observations.
    * As noted above, **all these entries are dropped**.

### Merge force - Risi

* **Number of resulting rows**: `r ppfjr$nrow`
* **Number of uses of force which occurred during a shift**: `r ppfjr$nr_outcome`
    * **Percentage of uses of force** (`r nrow(force)`): `r ppfjr$prcnt_outcome`%
    * **Number of fewer uses of force matched than Ba et al. 2021**: `r pretty_print_force$nr_outcome - ppfjr$nr_outcome`
    * **Percent reduction from Ba et al. 2021**: `r (pretty_print_force$nr_outcome - ppfjr$nr_outcome) / pretty_print_force$nr_outcome * 100`%
* **Number of shift assignments retained:** `r ppfjr$nr_shift`
    * **Percentage of shift assignments**: `r ppfjr$prcnt_shift`% **NOTE** this should be 100%.
* `r ppfjr$nr_missing_shifts` shift assignments matched with at least one use of force **without having** a start time and an end time. **NOTE** that this should be 0.
* There are `r ppfjr$nr_dupe_outcomes` uses of force which match to more than one shift assignment.
    * These **duplicate** uses of force represent `r ppfjr$prcnt_dupe_outcomes`% of all uses of force (`r nrow(force)`).
    * `r ppfjr$nr_dupe_shifts` shift assignments are affected or `r ppfjr$prcnt_dupe_shifts`% of all shift assignments.
    * In total, there are `r ppfjr$nr_dupes` **duplicate force-shift observations** representing `r ppfjr$prcnt_dupes`% of all force-shift observations.
    * As noted above, **all these entries are dropped**.

## Final notes

* Shift assignments which are missing their start time and end time could potentially be imputed which is explored elsewhere. The number of records affected is so small though it is not currently a priority.
* Similarly efforts could be made to de-duplicate stops and determine the correct shift assignment they should be matched to. This is explored elsewhere, but ultimately the number of records affected is so small it is not currently a priority.
