---
title: "Data Schemas"
output: pdf_document
---

```{r, include = F}
library(knitr)
opts_chunk$set(message = F, echo = F, warning = F)

library(here)
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(stringr)
library(lubridate)
library(kableExtra)

source(here("functions.R"))
```

```{r}
read_path <- paste("clean-and-process", "input", sep = "/")
write_path <- paste("clean-and-process", "output", sep = "/")

officers <- my_read_csv(here(read_path, "officers.csv"))
force <- my_read_csv(here(read_path, "force.csv"))

assignments <- my_read_csv(here(read_path, "assignments.csv"))

assignments <-
    assignments %>%
    mutate(shift_id = as.character(row_number()),
           start_date = if_else(is.na(start_time), NA_Date_, date),
           start_hms = hms::hms(rep(0, nrow(assignments)),
                                rep(0, nrow(assignments)),
                                start_time),
           start_datetime = as_datetime(paste0(start_date, " ", start_hms)),
           end_date = case_when(is.na(end_time) ~ NA_Date_,
                                end_time > 24 ~ date + 1,
                                TRUE ~ date),
           end_hms = hms::hms(rep(0, nrow(assignments)),
                              rep(0, nrow(assignments)),
                              case_when(is.na(end_time) ~ NA_real_,
                                        end_time > 24 ~ end_time - 24,
                                        TRUE ~ end_time)),
           end_datetime = as_datetime(paste0(end_date, " ", end_hms)),
           start_datetime_max = if_else(is.na(start_datetime),
                                        as_datetime(paste0(date, " 00:00:01")),
                                        start_datetime),
           end_datetime_max = if_else(is.na(end_datetime) | end_time > 24,
                                      as_datetime(paste0(date + 1, " 11:59:59")),
                                      end_datetime)) %>%
    select(-start_date, -start_hms, -end_date, -end_hms)

stops <-
    my_read_csv(here(read_path, "stops.csv")) %>%
    mutate(stop_officer_id = as.character(row_number()))

arrests <-
    my_read_csv(here(read_path, "arrests.csv")) %>%
    mutate(arrest_officer_id = as.character(row_number()))

summaries <-
    map(list("officers" = officers,
             "force" = force,
             "assignments" = assignments,
             "stops" = stops,
             "arrests" = arrests),
        GetSummary)

dfs <- list(officers = officers,
            assignments = assignments,
            stops = stops,
            arrests = arrests,
            force = force)

output_paths <- as.list(here(write_path, paste0("cleaned_", names(dfs), ".csv")))

pwalk(list(dfs, output_paths), function(df, path) {write_csv(df, path)})
```

## Officer Roster

* **birth_year**: Birth year of the officer.
* **appointed_month**: The month and year the officer was made an officer in YYYY-MM-DD format. The day is always the first day of the month.
* **officer_id**: Unique identifier for each officer.
* **officer_race**: Race of the officer.
* **officer_gender**: Sex of the officer.
* **spanish**: Does the officer speak Spanish or not?
* Uniquely identified by **officer_id**. The unit of observation is an officer.
* **Number of officers**: `r nrow(officers)`

```{r, results = "asis"}
map(summaries[["officers"]], kable, format = "latex")
```

## Shift Assignments

* **officer_id**: Unique identifier for each officer.
* **month**: Month of the shift in YYYY-MM-DD format. The day is always the first day of the month.
* **rank**: Rank of the officer assigned to the shift.
* **unit**: Unit of the officer assigned to the shift.
* **date**: Date of the shift in YYYY-MM-DD format.
* **shift**: The shift the officer is assigned to.
* **start_time**: Hour start time of the shift in military time.
* **end_time**: Hour end time of the shift in military time.
* **start_datetime**: Combines **start_time** and **date** into a starting datetime for the shift in YYYY-MM-DD HH:MM:SS format. **Created by me.**
* **end_datetime**: Combines **end_time** and **date** into an ending datetime for the shift in YYYY-MM-DD HH:MM:SS format. **Created by me.**
* **start_datetime_max**: When the **start_time** is missing, assume the earliest possible start time. **Created by me**.
* **end_datetime_max**: When the **end_time** is missing, assume the latest possible end time. **Created by me**.
* **weekday**: Day of the week of the shift.
* **beat_assigned**: The beat the officer is assigned to.
* **appointed_month**: The month and year the officer was made an officer.
* **months_from_start**: The number of months between the officer's appointment date and their shift date.
* **months_from_start_sq**: The number of months between the officer's appointment date and their shift date, squared.
* **duration**: Length of the shift in hours.
* **shift_id**: Unique identifier for each shift assignment. **Created by me**.
* Uniquely identified by **officer_id** and **date** or **shift_id**. The unit of observation is a specific shift for a specific officer.
* **Number of shift assignments**: `r nrow(assignments)`

```{r, results = "asis"}
numericTable <- summaries[["assignments"]][["numeric"]]
summaries[["assignments"]][["numeric"]] <- NULL
map(summaries[["assignments"]], kable, format = "latex")

numericTable %>%
    kable(format = "latex") %>%
    kable_styling(latex_options = "scale_down")
```

## Stops

* **stop_id**: Identifier for each stop.
* **time**: Time of the stop in YYYY-MM-DD HH:MM:SS format.
* **date**: Date of the stop in YYYY-MM-DD format.
* **district**: Police district where the stop took place.
* **po_first**: Was the focal officer the first to respond to the scene?
* **stop_type**: What was the type of the stop?
* **contact_type**: Collapsed version of **stop_type** (less categories).
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **lat**: Latitude of the stop.
* **lon**: Longitude of the stop.
* **officer_id**: Unique identifier for the officer.
* **month**: Month of the stop in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **hour**: Hour of the day when the stop took place rounded to the nearest hour in military time.
* **stop_officer_id**: Unique identifier for each entry. **Created by me**.
* The unit of analysis is a unique officer involved in a stop. Each row can be uniquely identified by **officer_id** and **stop_id** or by **stop_officer_id**.
* Each stop involves only one civilian, but they can involve multiple officers. It is possible multiple stops are all a part of one larger incident involving multiple civilians. This can be investigated by examining stops that took place in the same location at the same time involving the same officers.
* **Number of rows**: `r nrow(stops)`
* **Number of unique stops**: `r length(unique(stops$stop_id))`

```{r, results = "asis"}
map(summaries[["stops"]], kable, format = "latex")
```

## Arrests

* **date**: Date of the arrest in YYYY-MM-DD format.
* **hour**: Hour of the day when the arrest took place rounded to the nearest hour in military time.
* **crime_code**: The suspected crime type causing the arrest.
* **statute_description**: More detailed categories describing what specific statute was suspected to have been violated.
* **lat**: Latitude of the arrest.
* **lon**: Longitude of the arrest.
* **district**: Police district where the arrest took place.
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **arrest_id**: Identifier for each arrest.
* **officer_id**: Unique identifier for each officer.
* **month**: Month of the arrest in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **arrest_officer_id**: Unique identifier for each entry. **Created by me**.
* The unit of analysis is a unique officer involved in an arrest. Each row can be uniquely identified by **officer_id** and **arrest_id** or by **arrest_officer_id**.
* Each arrest involves only one civilian, but they can involve multiple officers. It is possible multiple arrests are all a part of one larger incident involving multiple civilians. This can be investigated by examining arrests that took place in the same location at the same time involving the same officers.
* **Number of rows**: `r nrow(arrests)`
* **Number of unique arrests**: `r length(unique(arrests$arrest_id))`

```{r, results = "asis"}
map(summaries[["arrests"]], kable, format = "latex")
```

## Uses of Force

* **date**: Date of the use of force in YYYY-MM-DD format.
* **time**: Time of the use of force in YYYY-MM-DD HH:MM:SS format.
* **district**: Police district where the use of force took place.
* **lat**: Latitude of the use of force.
* **lon**: Longitude of the force.
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **civ.injured**: Was the civilian injured?
* **force_id**: Unique identifier for each use of force incident.
* **officer_id**: Unique identifier for each officer.
* **month**: Month of the arrest in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **hour**: Hour of the day when the use of force took place rounded to the nearest hour in military time.
* The unit of analysis is a use of force incident. Only one police officer is listed for each use of force incident. Each row can be uniquely identified by **force_id**.
* **Number of uses of force**: `r nrow(force)`

```{r, results = "asis"}
map(summaries[["force"]], kable, format = "latex")
```
