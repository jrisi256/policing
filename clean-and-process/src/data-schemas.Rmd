---
title: "Data Schemas"
output: pdf_document
---

```{r, include = F}
library(knitr)
opts_chunk$set(message = F, echo = F, warning = F)

library(here)
source(here("functions.R"))
```

```{r}
read_path <- paste("clean-and-process", "input", sep = "/")
write_path <- paste("clean-and-process", "output", sep = "/")

# officers <- my_read_csv(here(read_path, "officers.csv"))
force <- my_read_csv(here(read_path, "force.csv"))
# assignments <- my_read_csv(here(read_path, "assignments.csv"))

# create start and end times for the shift in a datetime format
# assignments <-
#     assignments %>%
#     mutate(shift_id = as.character(row_number()),
#            start_date = if_else(is.na(start_time), NA_Date_, date),
#            start_hms = hms::hms(rep(0, nrow(assignments)),
#                                 rep(0, nrow(assignments)),
#                                 start_time),
#            start_datetime = as_datetime(paste0(start_date, " ", start_hms)),
#            end_date = case_when(is.na(end_time) ~ NA_Date_,
#                                 end_time > 24 ~ date + 1,
#                                 TRUE ~ date),
#            end_hms = hms::hms(rep(0, nrow(assignments)),
#                               rep(0, nrow(assignments)),
#                               case_when(is.na(end_time) ~ NA_real_,
#                                         end_time > 24 ~ end_time - 24,
#                                         TRUE ~ end_time)),
#            end_datetime = as_datetime(paste0(end_date, " ", end_hms))) %>%
#     select(-start_date, -start_hms, -end_date, -end_hms)

stops <-
    my_read_csv(here(read_path, "stops.csv")) %>%
    mutate(stop_officer_id = as.character(row_number()))

arrests <-
    my_read_csv(here(read_path, "arrests.csv")) %>%
    mutate(arrest_officer_id = as.character(row_number()))

# Summarize each of the data sets
summaries <-
    map(list(#"officers" = officers,
             "force" = force,
             # "assignments" = assignments,
             "stops" = stops,
             "arrests" = arrests),
        GetSummary)

# Write out the new data sets as "cleaned"
dfs <- list(#officers = officers,
            #assignments = assignments,
            stops = stops,
            arrests = arrests,
            force = force)

output_paths <- as.list(here(write_path, paste0("cleaned-", names(dfs), ".csv")))
pwalk(list(dfs, output_paths), function(df, path) {write_csv(df, path)})
```

## Officer Roster

* **birth_year**: Birth year of the officer.
* **appointed_month**: The month and year the officer was made an officer in YYYY-MM-DD format. The day is always the first day of the month.
* **officer_id**: Unique identifier for each officer.
* **officer_race**: Race of the officer.
* **officer_gender**: Sex of the officer.
* **spanish**: Does the officer speak Spanish or not?
* Uniquely identified by **officer_id**. The unit of observation is an officer.
* **Number of officers**: `r nrow(officers)`

### Creating the officer roster

> "The administrative data from the CPD used in this study span multiple datasets collected in collaboration with the Invisible Institute, Sam Stecklow, and Emma Herman over the course of three years (2016-2019). We obtained these records from the Chicago Police Department or Chicago Department of Human Resources via Freedom of Information Act (FOIA) or through court ordered releases stemming from requests made by Invisible Institute and Jaime Kalven. CPD provided the following data: rosters of all available current and past officers up to 2018, unit history data for individual officers from the 1930s to 2016, Tactical Response Reports from 2004 to 2018 (i.e. use of force reports), and arrest data with arresting officers and arrestee demographic information from 2001 to 2017. The Chicago Department of Human Resources provided data on officers’ language skills up to 2019. We supplement our core data with data on 'Stop, Question and Frisk' (SQF) activity between 2012-2015, which was shared by the Lucy Parson’s Lab. Finally, the Automated Daily Attendance and Assignment sheet data for each police district between 2012 and 2015 was obtained via a FOIA request to the CPD and shared by Rachel Ryley." pages 5-6 of Appendix Section S1.2 in Ba et al. 2021.

> "These data and others have been used to construct rich profiles of Chicago Police Officers. While no file contains a unique identifier (star numbers change over time, names are common, etc.), we constructed unique officer profiles through a successive merge process described here. Each file contains some identifying information such as of demographic data (birth year, race, gender) or other characteristics (name, start/badge number, appointed date, resignation date, current unit). We used these identifying characteristics to first de-duplicate officers within a file and to then merge to pre-existing officer data with inter-file unique identifiers. The merging process itself is an iterative-pairwise matching method, where the officers in each dataset are repeatedly merged on identifying characteristics and any successful 1-to-1 match in a round removes the matched officers from the next round of merging." page 6 of Appendix Section S1.2 in Ba et al. 2021.

### Officer Race

> "We determine race/ethnicity of CPD officers based on demographic data obtained from the CPD through FOIA. The CPD usually classifies race/ethnicity in at most 7 mutually exclusive groups: White/Caucasian, White Hispanic, Black/African American, Black Hispanic, Asian/Pacific Islander, Native American/Native Alaskan, and unknown/missing. However, there are inconsistencies in how races and ethnicities are coded across files. For example, some files do not include 'Black Hispanic' as a racial category (very few officers are ever classified as Black Hispanic), and some files contain outdated racial categories which we update to the best of our ability. For consistency, we classify 'Hispanic' and 'White Hispanic' as 'Hispanic'; 'Black' and 'Black Hispanic' (rare cases) as 'Black.' 'White' in our analysis refers to non-Hispanic White. If an officer has multiple races associated with them across different datasets, we aggregate by most common non-missing races." page 5 of Appendix Section S1.1 in Ba et al. 2021.

```{r, results = "asis"}
#map(summaries[["officers"]], kable, format = "latex")
```

## Shift Assignments

* **officer_id**: Unique identifier for each officer.
* **month**: Month of the shift in YYYY-MM-DD format. The day is always the first day of the month.
* **rank**: Rank of the officer assigned to the shift.
* **unit**: Unit of the officer assigned to the shift.
* **date**: Date of the shift in YYYY-MM-DD format.
* **shift**: The shift the officer is assigned to.
* **start_time**: Hour start time of the shift in military time.
* **end_time**: Hour end time of the shift in military time.
* **start_datetime**: Combines **start_time** and **date** into a starting datetime for the shift in YYYY-MM-DD HH:MM:SS format. **Created by me.**
* **end_datetime**: Combines **end_time** and **date** into an ending datetime for the shift in YYYY-MM-DD HH:MM:SS format. **Created by me.**
* **weekday**: Day of the week of the shift.
* **beat_assigned**: The beat the officer is assigned to.
* **appointed_month**: The month and year the officer was made an officer.
* **months_from_start**: The number of months between the officer's appointment date and their shift date.
* **months_from_start_sq**: The number of months between the officer's appointment date and their shift date, squared.
* **duration**: Length of the shift in hours.
* **shift_id**: Unique identifier for each shift assignment. **Created by me**.
* Uniquely identified by **officer_id** and **date** or **shift_id**. The unit of observation is a specific shift for a specific officer.
* **Number of shift assignments**: `r nrow(assignments)`

```{r, results = "asis"}
# numericTable <- summaries[["assignments"]][["numeric"]]
# summaries[["assignments"]][["numeric"]] <- NULL
# map(summaries[["assignments"]], kable, format = "latex")
# 
# # Have to do this because the numeric table is too wide
# numericTable %>%
#     kable(format = "latex") %>%
#     kable_styling(latex_options = "scale_down")
```

## Stops

* **stop_id**: Identifier for each stop.
* **time**: Time of the stop in YYYY-MM-DD HH:MM:SS format.
* **date**: Date of the stop in YYYY-MM-DD format.
* **district**: Police district where the stop took place.
* **po_first**: Was the focal officer the first to respond to the scene?
* **stop_type**: What was the type of the stop?
* **contact_type**: Collapsed version of **stop_type** (less categories).
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **lat**: Latitude of the stop.
* **lon**: Longitude of the stop.
* **officer_id**: Unique identifier for the officer.
* **month**: Month of the stop in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **hour**: Hour of the day when the stop took place rounded to the nearest hour in military time.
* **stop_officer_id**: Unique identifier for each entry. **Created by me**.
* The unit of analysis is a unique officer involved in a stop. Each row can be uniquely identified by **officer_id** and **stop_id** or by **stop_officer_id**.
* Each stop involves only one civilian, but they can involve multiple officers. It is possible multiple stops are all a part of one larger incident involving multiple civilians. This can be investigated by examining stops that took place in the same location at the same time involving the same officers.
* **Number of rows**: `r nrow(stops)`
* **Number of unique stops**: `r length(unique(stops$stop_id))`

### Stop Type vs. Contact Type

> "Stops for 'dispersal' and 'gang and narcotics-related loitering' are coded as loitering stops; those that are 'gang / narcotics related' are coded as drug stops; 'investigatory stops' and stops of 'suspicious persons' are coded as suspicious behavior; and stops under the 'Repeat Offender Geographic Urban Enforcement Strategy (ROGUES)' program are combined with the 'other' category." page 8 of Appendix Section S1.5 in Ba et al. 2021.

```{r, results = "asis"}
map(summaries[["stops"]], kable, format = "latex")
```

## Arrests

* **date**: Date of the arrest in YYYY-MM-DD format.
* **hour**: Hour of the day when the arrest took place rounded to the nearest hour in military time.
* **crime_code**: The suspected crime type causing the arrest.
* **statute_description**: More detailed categories describing what specific statute was suspected to have been violated.
* **lat**: Latitude of the arrest.
* **lon**: Longitude of the arrest.
* **district**: Police district where the arrest took place.
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **arrest_id**: Identifier for each arrest.
* **officer_id**: Unique identifier for each officer.
* **month**: Month of the arrest in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **arrest_officer_id**: Unique identifier for each entry. **Created by me**.
* The unit of analysis is a unique officer involved in an arrest. Each row can be uniquely identified by **officer_id** and **arrest_id** or by **arrest_officer_id**.
* Each arrest involves only one civilian, but they can involve multiple officers. It is possible multiple arrests are all a part of one larger incident involving multiple civilians. This can be investigated by examining arrests that took place in the same location at the same time involving the same officers.
* **Number of rows**: `r nrow(arrests)`
* **Number of unique arrests**: `r length(unique(arrests$arrest_id))`

```{r, results = "asis"}
map(summaries[["arrests"]], kable, format = "latex")
```

## Uses of Force

* **date**: Date of the use of force in YYYY-MM-DD format.
* **time**: Time of the use of force in YYYY-MM-DD HH:MM:SS format.
* **district**: Police district where the use of force took place.
* **lat**: Latitude of the use of force.
* **lon**: Longitude of the force.
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **civ.injured**: Was the civilian injured?
* **force_id**: Unique identifier for each use of force incident.
* **officer_id**: Unique identifier for each officer.
* **month**: Month of the arrest in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **hour**: Hour of the day when the use of force took place rounded to the nearest hour in military time.
* The unit of analysis is a use of force incident. Only one police officer is listed for each use of force incident. Each row can be uniquely identified by **force_id**.
* **Number of uses of force**: `r nrow(force)`

```{r, results = "asis"}
map(summaries[["force"]], kable, format = "latex")
```
