---
title: "Association Between District Racial Composition and Stopping Rate of Minorities"
header-includes: \usepackage{booktabs}
output: pdf_document
---

## Links

* [Fixed Effects in R](https://cran.r-project.org/web/packages/fixest/vignettes/fixest_walkthrough.html)
* [Paper outlining the logic behind fixed effects and clustering](http://cameron.econ.ucdavis.edu/research/Cameron_Miller_JHR_2015_February.pdf)
* [What to do when you have time invariant predictors?](https://www.lesahoffman.com/CLP945/CLP945_Lecture2_Time-Invariant.pdf)
* [Brief tutorial for Fixed Effects Regression](https://towardsdatascience.com/understanding-the-fixed-effects-regression-model-d2fccc2cc27e)
* [Ideas for how to improve the interpretation of fixed effects models](https://www.cambridge.org/core/journals/political-science-research-and-methods/article/improving-the-interpretation-of-fixed-effects-regression-results/4145615389057E25D4B46D44AC9CB89C)
* [Another article helping to interpret Fixed Effects](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0231349)

## Crime

* Violent crime encompasses murder, assault, rape, and robbery.
* Property crime encompasses burglary, larceny, motor vehicle theft, and arson.

```{r, include = F}
library(knitr)
opts_chunk$set(message = F, echo = F)

library(sf)
library(here)
source(here("functions.R"))

districts_shape <-
    st_read(dsn = here("clean-and-process", "input", "district_shape"),
            layer = "geo_export_427fc6e8-19e2-4435-b9e4-0566a20fa39c") %>%
    filter(dist_num != 31) %>%
    select(dist_num)

panel1 <-
    read_csv(here("clean-and-process", "input", "monthly-panel_2002-2016.csv")) %>%
    mutate(race = tolower(race),
           race = case_when(race == "asian/pacific islander" ~ "aapi",
                            race == "hispanic" ~ "hisp",
                            race == "native american/alaskan native" ~ "native",
                            T ~ race),
           officer_id = as.character(officer_id))

panel2 <-
    read_csv(here("clean-and-process", "input", "monthly_panel_units_1965-2016.csv")) %>%
    mutate(officer_id = as.character(officer_id))

panel <-
    full_join(panel2, panel1) %>%
    mutate(unit = as.numeric(unit)) %>%
    filter(year(month) >= 2013,
           year(month) <= 2015,
           unit <= 25,
           !(unit %in% c(13, 21, 23))) %>%
    mutate(unit = as.character(unit)) %>%
    mutate(employed = 1)
setDT(panel)
setkey(panel, officer_id, month, unit)

# if officer-months were previously not in the data, insert them with "0"
panel <- panel[CJ(officer_id = sort(unique(panel$officer_id)), month = sort(unique(panel$month))),]
panel <- panel %>% mutate(employed = if_else(is.na(employed), 0, 1))

crime <-
    read_csv(here("clean-and-process", "input", "Crime_demographics_districts.csv")) %>%
    select(district, year, month, violent_cr, property_cr) %>%
    rename(unit = district) %>%
    mutate(year = as.factor(year), month = as.factor(month), unit = as.factor(unit))
```

## Generate the demographic composition of each police unit in each month

* Calculate the total number of officers and the mean amount of work experience in each unit for each month.
* Calculate the number and percentage of Black, Hispanic, White, and Asian American/Pacific Islander officers for each unit for each month.
* Calculate the number and percentage of male and female officers for each unit for each month.

> "The CPD currently subdivides Chicago into 22 policing districts which correspond to CPD units, in which the majority of police officers work. A typical district covers roughly ten square miles. There were 25 districts (numbered 1â€“25) until 2012, at which time 3 smaller districts were eliminated and merged with other districts. Districts 23 and 21 and District 13 were eliminated and absorbed into neighboring districts in March and December of 2012, respectively. While District 23 was mostly absorbed by District 19 and most of District 13 was absorbed by District 12, significant parts of District 21 were absorbed by Districts 1, 2, and 9. page 11 of Appendix Section S2.2 in Ba et al. 2021

* To ensure an apples-to-apples comparison, I will be only comparing the current 22 police districts using data from 2013 - 2015.

```{r}
police_units <-
    panel %>%
    filter(employed == 1) %>%
    mutate(days_of_exp = interval(appointed_month, month) %/% days(1)) %>%
    group_by(unit, month) %>%
    summarise(nr_officer = n(), mean_days_exp = mean(days_of_exp, na.rm = T))

police_units_race <-
    panel %>%
    filter(employed == 1) %>% 
    group_by(unit, month, race) %>%
    summarise(nr_officer = n()) %>%
    group_by(unit, month) %>%
    mutate(prcnt_officer = nr_officer / sum(nr_officer)) %>%
    ungroup() %>%
    filter(!is.na(race)) %>%
    pivot_wider(id_cols = c("unit", "month"),
                names_from = "race",
                values_from = c("nr_officer", "prcnt_officer"))

police_units_gender <-
    panel %>%
    filter(employed == 1) %>% 
    group_by(unit, month, gender) %>%
    summarise(nr_officer = n()) %>%
    group_by(unit, month) %>%
    mutate(prcnt_officer = nr_officer / sum(nr_officer)) %>%
    ungroup() %>%
    filter(!is.na(gender)) %>%
    pivot_wider(id_cols = c("unit", "month"),
                names_from = "gender",
                values_from = c("nr_officer", "prcnt_officer"))

police_units_final <-
    reduce(list(police_units, police_units_race, police_units_gender),
           full_join,
           by = c("unit", "month"))
```

```{r}
outcomes <- read_csv(here("clean-and-process", "src", "old_stuff", "assignments_with_outcomes.csv"))

shift_outcomes_final <-
    outcomes %>%
    group_by(month, unit) %>%
    summarise(stops = sum(stops_n, na.rm = T),
              arrests = sum(arrests_n, na.rm = T),
              force = sum(force_n, na.rm = T),
              black_stops = sum(stops_black, na.rm = T),
              black_arrests = sum(arrests_black, na.rm = T),
              black_force = sum(force_black, na.rm = T),
              hispanic_stops = sum(stops_hispanic, na.rm = T),
              hispanic_arrests = sum(arrests_hispanic, na.rm = T),
              hispanic_force = sum(force_hispanic, na.rm = T),
              white_stops = sum(stops_white, na.rm = T),
              white_arrests = sum(arrests_white, na.rm = T),
              white_force = sum(force_white, na.rm = T),
              other_stops = sum(stops_other, na.rm = T),
              other_arrests = sum(arrests_other, na.rm = T),
              other_force = sum(force_other, na.rm = T)) %>%
    ungroup() %>%
    filter(year(month) >= 2013,
           year(month) <= 2015,
           !(unit %in% c(13, 21, 23))) %>%
    mutate(unit = as.factor(unit))
```

## Read in census data

* Percentage of individuals in poverty
* Percentage of households which are single-parent families (male or female headed)
* Percentage of individuals 25 and older without a high school education
* Percentage of individuals who are foreign born
* Percentage of individuals who are not in the labor force
* I collect census tracts and use the centroid of each census tract to assign each census tract to a police district. I then aggregate the raw totals of each census tract to the police district level to come up with a summed total for the police district. I then calculate the percentage outcome variables.
* **ISSUE**: Because the period of time I am covering is only from 2013-2015, I use the 2011-2015 5-year ACS data. However, this means there is only **one** time period observation for each of these variables which leads to issues of collinearity. More importantly, it defeats the purpose of fixed effects which is theoretically supposed to capture the effect of time-invariant variables (which in this case could technically be argued is the disadvantage of these neighborhoods).
* I also estimated a PCA model to deal with the underlying correlation in these variables, and it seems like these variables can be decomposed into two factors.
However, this is a bit of a moot point at the moment because of the above issue.

```{r}
# Read in family status and immigration status
family_immigration <- read_csv(here("clean-and-process", "input", "census_family_immigration.csv"))
colnames(family_immigration) <-
    c("total_households", "male_single", "female_single", "pop_25older",
      "less9th", "more9thless12th", "total_pop", "foreign_born", "nat_citz",
      "not_citz", "GEOID", "NAME")
family_immigration <-
    family_immigration %>%
    mutate(GEOID = str_replace(GEOID, "1400000US", "")) %>%
    select(-NAME)

# Read in poverty and unemployment
economics <- read_csv(here("clean-and-process", "input", "census_economics.csv"))
colnames(economics) <-
    c("pop_16older", "labor_force", "prcnt_poverty", "GEOID", "NAME")
economics <-
    economics %>%
    mutate(GEOID = str_replace(GEOID, "1400000US", ""),
           prcnt_poverty = if_else(prcnt_poverty == "-",
                                   as.character(0), 
                                   prcnt_poverty),
           prcnt_poverty = as.numeric(prcnt_poverty)) %>%
    select(-NAME)

# Read in demographics
pop <- read_csv(here("clean-and-process", "input", "census_population.csv"))
colnames(pop) <-
    c("total_pop", "hispanic", "white", "black", "GEOID", "NAME")
pop <-
    pop %>%
    mutate(GEOID = str_replace(GEOID, "1400000US", "")) %>%
    select(-total_pop,)

# Filter to Chicago
census_tract_shapes <-
    st_read(here("clean-and-process", "input", "census-tract_shape")) %>%
    filter(COUNTYFP == "031") %>%
    select(GEOID, NAMELSAD) %>%
    st_centroid()

census_outcomes <-
    reduce(list(family_immigration, economics, pop, census_tract_shapes),
           full_join, by = "GEOID") %>%
    mutate(across(-c("NAMELSAD", "geometry", "GEOID", "NAME"), ~as.numeric(.x))) %>%
    mutate(nr_poverty = prcnt_poverty / 100 * total_pop) %>%
    select(-prcnt_poverty) %>%
    st_as_sf() %>%
    st_transform(st_crs(districts_shape))

census_outcomes_final <-
    st_join(census_outcomes, districts_shape) %>%
    filter(!is.na(dist_num)) %>%
    select(-GEOID, -NAMELSAD, -NAME) %>%
    group_by(dist_num) %>%
    summarise(across(-c("geometry"), ~sum(.x))) %>%
    mutate(prcnt_single = (male_single + female_single) / total_households,
           prcnt_hs = (less9th + more9thless12th) / pop_25older,
           prcnt_foreign = foreign_born / total_pop,
           prcnt_notlf = 1 - (labor_force / pop_16older),
           prcnt_poverty = nr_poverty / total_pop,
           prcnt_civ_black = black / total_pop,
           prcnt_civ_hispanic = hispanic / total_pop,
           prcnt_civ_white = white / total_pop) %>%
    select(matches("prcnt"), dist_num, black, hispanic, white, total_pop) %>%
    rename(unit = dist_num) %>%
    st_drop_geometry()

library(factoextra)
pca <-
    select(census_outcomes_final, prcnt_single, prcnt_hs, prcnt_foreign,
           prcnt_notlf, prcnt_poverty) %>%
    prcomp(center = T, scale = T)

pcaDat <- get_pca(pca)$coord

census_outcomes_final <-
    census_outcomes_final %>%
    mutate(PCA1 = pca$x[, 1], PCA2 = pca$x[, 2])

fviz_screeplot(pca, addlabels = T, choice = "variance")
```

```{r}
final_vars <-
    full_join(shift_outcomes_final, police_units_final, by = c('unit', 'month')) %>%
    full_join(census_outcomes_final, by = "unit") %>%
    mutate(black_diff = prcnt_officer_black - prcnt_civ_black,
           hispanic_diff = prcnt_officer_hisp - prcnt_civ_hispanic,
           white_diff = prcnt_officer_white - prcnt_civ_white,
           black_ratio = prcnt_officer_black / prcnt_civ_black,
           hispanic_ratio = prcnt_officer_hisp / prcnt_civ_hispanic,
           white_ratio = prcnt_officer_white / prcnt_civ_white,
           black_stop_rate = round(black_stops / black * 10000),
           log_total_officers = log(nr_officer),
           log_black_officers = log(nr_officer_black),
           log_white_officers = log(nr_officer_white),
           log_hispanic_officers = log(nr_officer_hisp),
           disadvantage = (prcnt_poverty + prcnt_single + prcnt_notlf) / 3,
           date = month,
           unit = as.factor(unit),
           year = as.factor(year(month)),
           month = as.factor(month(month))) %>%
    left_join(crime, by = c("month", "year", "unit")) %>%
    mutate(violent_cr_capita = violent_cr / total_pop * 1000,
           property_cr_capita = property_cr / total_pop * 1000,
           year = fct_drop(year))

write_csv(final_vars,
          here("clean-and-process", "src", "old_stuff", "final_data.csv"))
```
