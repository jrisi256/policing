---
title: "Data Schema Descriptions"
output: pdf_document
---

```{r, include = F}
set.seed(420)

library(knitr)
opts_chunk$set(message = F, echo = F, fig.width = 12, fig.height = 14)

library(here)
library(readr)
library(dplyr)
library(GGally)
library(ggplot2)
library(forcats)
library(lubridate)

source(here("functions.R"))
```

```{r}
read_path <- paste("0-clean-data", "input", sep = "/")
write_path <- paste("0-clean-data", "output", sep = "/")

officers <- my_read_csv("officers.csv", path = here(read_path))
force <- my_read_csv("force.csv", path = here(read_path))

assignments <-
    my_read_csv("assignments.csv", path = here(read_path)) %>%
    mutate(shift_id = as.character(row_number())) %>%
    select(-appointed_month, -months_from_start_sq)

stops <-
    my_read_csv("stops.csv", here(read_path)) %>%
    mutate(stop_officer_id = as.character(row_number())) %>%
    mutate(civ.gender = fct_recode(civ.gender, NULL = "X"))

arrests <-
    my_read_csv("arrests.csv", here(read_path)) %>%
    mutate(arrest_officer_id = as.character(row_number()))

write_csv(officers, here(write_path, "cleaned_officers.csv"))
write_csv(assignments, here(write_path, "cleaned_assignments.csv"))
write_csv(stops, here(write_path, "cleaned_stops.csv"))
write_csv(arrests, here(write_path, "cleaned_arrests.csv"))
write_csv(force, here(write_path, "cleaned_force.csv"))

my_skim(officers)
my_skim(assignments)
my_skim(stops)
my_skim(arrests)
my_skim(force)
```

## Officer Roster

* **birth_year**: Birth year of the officer.
* **appointed_month**: The month and year the officer was made an officer in YYYY-MM-DD format. The day is always the first day of the month.
* **officer_id**: Unique identifier for each officer.
* **officer_race**: Race of the officer.
* **officer_gender**: Sex of the officer.
* **spanish**: Does the officer speak Spanish or not?
* Uniquely identified by **officer_id**. The unit of observation is an officer.
* **Number of officers**: `r nrow(officers)`

## Shift Assignments

* **officer_id**: Unique identifier for each officer.
* **month**: Month of the shift in YYYY-MM-DD format. The day is always the first day of the month.
* **rank**: Rank of the officer assigned to the shift.
* **unit**: Unit of the officer assigned to the shift.
* **date**: Date of the shift in YYYY-MM-DD format.
* **shift**: The shift the officer is assigned to.
* **start_time**: Hour start time of the shift in military time.
* **end_time**: Hour end time of the shift in military time.
* **weekday**: Day of the week of the shift.
* **beat_assigned**: The beat the officer is assigned to.
* **appointed_month**: The month and year the officer was made an officer. **Dropped as it's redundant**.
* **months_from_start**: The number of months between the officer's appointment date and their shift date.
* **months_from_start_sq**: The number of months between the officer's appointment date and their shift date, squared. **Dropped as it can be recreated**.
* **duration**: Length of the shift in hours.
* **shift_id**: Unique identifier for each shift assignment. **Created by me**.
* Uniquely identified by **officer_id** and **date** or **shift_id**. The unit of observation is a specific shift for a specific officer.
* **Number of shift assignments**: `r nrow(assignments)`

## Stops

* **stop_id**: Identifier for each stop.
* **time**: Time of the stop in YYYY-MM-DD HH:MM:SS format.
* **date**: Date of the stop in YYYY-MM-DD format.
* **district**: Police district where the stop took place.
* **po_first**: Was the focal officer the first to respond to the scene?
* **stop_type**: What was the type of the stop?
* **contact_type**: Collapsed version of **stop_type** (less categories).
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **lat**: Latitude of the stop.
* **lon**: Longitude of the stop.
* **officer_id**: Unique identifier for the officer.
* **month**: Month of the stop in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **hour**: Hour of the day when the stop took place rounded to the nearest hour in military time.
* **stop_officer_id**: Unique identifier for each entry. **Created by me**.
* The unit of analysis is a unique officer involved in a stop. Each row can be uniquely identified by **officer_id** and **stop_id** or by **stop_officer_id**.
* Each stop involves only one civilian, but they can involve multiple officers. It is possible multiple stops are all a part of one larger incident involving multiple civilians. This can be investigated by examining stops that took place in the same location at the same time involving the same officers.
* **Number of rows**: `r nrow(stops)`
* **Number of unique stops**: `r length(unique(stops$stop_id))`

## Arrests

* **date**: Date of the arrest in YYYY-MM-DD format.
* **hour**: Hour of the day when the arrest took place rounded to the nearest hour in military time.
* **crime_code**: The suspected crime type causing the arrest.
* **statute_description**: More detailed categories describing what specific statute was suspected to have been violated.
* **lat**: Latitude of the arrest.
* **lon**: Longitude of the arrest.
* **district**: Police district where the arrest took place.
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **arrest_id**: Identifier for each arrest.
* **officer_id**: Unique identifier for each officer.
* **month**: Month of the arrest in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **arrest_officer_id**: Unique identifier for each entry. **Created by me**.
* The unit of analysis is a unique officer involved in an arrest. Each row can be uniquely identified by **officer_id** and **arrest_id** or by **arrest_officer_id**.
* Each arrest involves only one civilian, but they can involve multiple officers. It is possible multiple arrests are all a part of one larger incident involving multiple civilians. This can be investigated by examining arrests that took place in the same location at the same time involving the same officers.
* **Number of rows**: `r nrow(arrests)`
* **Number of unique arrests**: `r length(unique(arrests$arrest_id))`

## Uses of Force

* **date**: Date of the use of force in YYYY-MM-DD format.
* **time**: Time of the use of force in YYYY-MM-DD HH:MM:SS format.
* **district**: Police district where the use of force took place.
* **lat**: Latitude of the use of force.
* **lon**: Longitude of the force.
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **civ.injured**: Was the civilian injured?
* **force_id**: Unique identifier for each use of force incident.
* **officer_id**: Unique identifier for each officer.
* **month**: Month of the arrest in YYYY-MM-DD format. The day is always the first day of the month.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories).
* **hour**: Hour of the day when the use of force took place rounded to the nearest hour in military time.
* The unit of analysis is a use of force incident. Only one police officer is listed for each use of force incident. Each row can be uniquely identified by **force_id**.
* **Number of uses of force**: `r nrow(force)`

## Trends in officer data

```{r, }
officers %>%
    select(!is.character, -appointed_month) %>%
    mutate(officer_race = str_replace(officer_race, "officer_", "")) %>%
    filter(!is.na(officer_race) & !is.na(officer_gender)) %>%
    ggpairs(lower = list(combo = "facetdensitystrip",
                         discrete = wrap("colbar", size = 5)),
            upper = list(discrete = wrap("colbar", size = 5))) +
    theme_bw() +
    theme(axis.text = element_text(size = 13),
          strip.text = element_text(size = 13)) +
    ggtitle("Officers")
```

## Trends in shift assignment data

```{r}

```


## Trends in stop data

```{r}
stops %>%
    select(time, contact_type, civ.gender, civ.race) %>%
    filter(!is.na(civ.gender)) %>%
    mutate(civ.race = fct_recode(civ.race,
                                 aapi = "ASIAN/PACIFIC ISLANDER",
                                 naal = "AMER IND/ALASKAN NATIVE")) %>%
    ggpairs(lower = list(combo = "facetdensitystrip",
                         discrete = wrap("colbar", size = 5)),
            upper = list(discrete = wrap("colbar", size = 5))) +
    theme_bw() +
    theme(axis.text = element_text(size = 13),
          strip.text = element_text(size = 13)) +
    ggtitle("Stops Over Time")
```

```{r}
stops %>%
    select(civ.age, contact_type, civ.gender, civ.race) %>%
    filter(!is.na(civ.gender) & civ.age <= 100) %>%
    mutate(civ.race = fct_recode(civ.race,
                                 aapi = "ASIAN/PACIFIC ISLANDER",
                                 naal = "AMER IND/ALASKAN NATIVE")) %>%
    ggpairs(lower = list(combo = "facetdensitystrip",
                         discrete = wrap("colbar", size = 5)),
            upper = list(discrete = wrap("colbar", size = 5))) +
    theme_bw() +
    theme(axis.text = element_text(size = 13),
          strip.text = element_text(size = 13)) +
    ggtitle("Stops By Age")
```

```{r}
stops %>%
    filter(civ.age <= 100) %>%
    sample_frac(0.4) %>%
    ggplot(aes(x = civ.age, y = time)) +
    stat_density2d(aes(fill = ..level..), geom = "polygon") +
    scale_fill_continuous(type = "viridis") +
    theme_bw() +
    theme(axis.text = element_text(size = 13)) +
    ggtitle("2D Density Plot Examining Stops By Age Over Time")
```

```{r}
stops %>%
    filter(civ.age <= 100) %>%
    sample_frac(0.4) %>%
    ggplot(aes(x = civ.age, y = hour)) +
    stat_density2d(aes(fill = ..level..), geom = "polygon") +
    scale_fill_continuous(type = "viridis") +
    theme_bw() +
    theme(axis.text = element_text(size = 13)) +
    ggtitle("2D Density Plot Examining Stops By Age Over The Course of a Day")
```

```{r}
stops %>%
    filter(civ.age <= 100) %>%
    mutate(day_of_week = wday(time, label = T)) %>%
    ggplot(aes(x = civ.age)) +
    geom_density() + 
    facet_wrap(~day_of_week) +
    theme_bw() +
    theme(axis.text = element_text(size = 13)) +
    ggtitle("Density Plot Examining Stops By Age Over The Course of a Week")
```

```{r}
stops %>%
    filter(civ.age <= 100) %>%
    mutate(day_of_month = day(time)) %>%
    sample_frac(0.4) %>%
    ggplot(aes(x = civ.age, y = day_of_month)) +
    stat_density2d(aes(fill = ..level..), geom = "polygon") +
    scale_fill_continuous(type = "viridis") +
    theme_bw() +
    theme(axis.text = element_text(size = 13)) +
    ggtitle("2D Density Plot Examining Stops By Age Over The Course of a Month")
```

```{r}
stops %>%
    filter(civ.age <= 100) %>%
    mutate(day_of_year = yday(time)) %>%
    sample_frac(0.4) %>%
    ggplot(aes(x = civ.age, y = day_of_year)) +
    stat_density2d(aes(fill = ..level..), geom = "polygon") +
    scale_fill_continuous(type = "viridis") +
    theme_bw() +
    theme(axis.text = element_text(size = 13)) +
    ggtitle("2D Density Plot Examining Stops By Age Over The Course of a Year")
```

## Trends in arrest data

## Trends in use of force data