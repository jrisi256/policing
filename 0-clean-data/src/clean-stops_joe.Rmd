---
title: "Clean Police Officer Stops"
output: pdf_document
---

```{r, include = F}
library(knitr)
opts_chunk$set(message = F, echo = F)

library(here)
library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
library(data.table)
```

```{r}
assignments_ba_dt <-
  fread(here("0-clean-data", "output", "officer_assignments-ba.csv")) %>%
  mutate(date = ymd(date))

stops_dt <-
  fread(here("0-clean-data", "input", "bocar-ba_data", "stops.csv")) %>%
  select(-civilian_race_short, -month) %>%
  mutate(date = ymd(date),
         stop_officer_id = row_number())
```

## Officer stops

* **stop_id**: Unique identifier for each stop.
* **time**: Time of stop.
* **date**: Date of stop.
* **district**: Police district where the stop took place.
* **po_first**: Was the focal officer the first to respond to the scene?
* **stop_type**: What was the type of the stop?
* **contact_type**: Collapsed version of **stop_type** (less categories).
* **civ.race**: Race of the civilian.
* **civ.gender**: Sex of the civilian.
* **civ.age**: Age of the civilian at the time of the stop.
* **lat**: Latitude of the stop.
* **lon**: Longitude of the stop.
* **officer_id**: Unique identifier for the officer.
* **month**: Month of stop. **Dropped as it can be recreated**.
* **civilian_race_short**: Collapsed version of **civ.race** (less categories). **Dropped as it can be recreated**.
* **hour**: Hour of the day when the stop took place.
* **stop_officer_id**: Unique identifier for each entry.
* The unit of analysis is a unique officer involved in a stop. Each row can be uniquely identified by **officer_id** and **stop_id** or by **stop_officer_id**.
* Each stop involves only one civilian, but they can involve multiple officers. It is possible multiple stops are all a part of one larger incident involving multiple civilians. This can be investigated by examining stops that took place in the same location at the same time involving the same officers.
* **Number of stops**: `r nrow(stops_dt)`
* **Number of unique stops**: `r length(unique(stops_dt$stop_id))`

## Merge stops to officer shift assignments

1. Convert the start time and end time for the shifts to standardized date times.

```{r}
# Convert the assignment start and end dates to standardized date times
assignments_ba_dt <-
    assignments_ba_dt %>%
    mutate(start_date = if_else(is.na(start_time), NA_Date_, date),
           start_hms = hms::hms(rep(0, nrow(assignments_ba_dt)),
                                rep(0, nrow(assignments_ba_dt)),
                                start_time),
           start_time = as_datetime(paste0(start_date, " ", start_hms)),
           end_date = if_else(end_time > 24, date + 1, date),
           end_hms = hms::hms(rep(0, nrow(assignments_ba_dt)),
                              rep(0, nrow(assignments_ba_dt)),
                              if_else(end_time > 24, end_time - 24, end_time)),
           end_time = as_datetime(paste0(end_date, " ", end_hms))) %>%
    select(-start_date, -start_hms, -end_date, -end_hms)

# Set the key to make the joining go faster
setkey(stops_dt, officer_id, time)
setkey(assignments_ba_dt, officer_id, start_time, end_time)

a <-
    assignments_ba_dt %>%
    mutate(start_time = floor_date(start_time, unit = "hour"),
           end_time = ceiling_date(end_time, unit = "hour"))

b <- stops_dt %>% mutate(time = floor_date(time, unit = "hour"))

setkey(a, officer_id, start_time, end_time)
setkey(b, officer_id, time)

join <- b[a, on = .(officer_id, time >= start_time, time <= end_time)]

stops_shift_assignments <-
    stops_dt[assignments_ba_dt,
             on = .(officer_id, time >= start_time, time <= end_time)]
```

```{r}
stops_flag <-
    stops_shift_assignments %>%
    mutate(stopCount = if_else(is.na(stop_officer_id), 0 , 1))

stops_total <-
    stops_flag %>%
    count(shift_id, wt = stopCount) %>%
    rename(stops_n_total = n)

stops_contact <-
    stops_flag %>%
    count(shift_id, contact_type, wt = stopCount) %>%
    filter(!is.na(contact_type)) %>%
    mutate(contact_type = paste0("stops_n_", contact_type)) %>%
    pivot_wider(id_cols = shift_id,
                names_from = contact_type,
                values_from = n,
                values_fill = 0)

stops_civrace <-
    stops_flag %>%
    count(shift_id, civ.race, wt = stopCount) %>%
    filter(!is.na(civ.race)) %>%
    mutate(civ.race = tolower(civ.race)) %>%
    mutate(civ.race = case_when(civ.race == "asian/pacific islander" ~ "aapi",
                                civ.race == "amer ind/alaskan native" ~ "aian",
                                T ~ civ.race)) %>%
    mutate(civ.race = paste0("stops_n_civilian_", civ.race)) %>%
    pivot_wider(id_cols = shift_id,
                names_from = civ.race,
                values_from = n,
                values_fill = 0)

assignments_outcomes <-
    assignments_ba_dt %>%
    full_join(stops_total, by = "shift_id") %>%
    full_join(stops_civrace, by = "shift_id") %>%
    full_join(stops_contact, by = "shift_id") %>%
    mutate(across(matches("stops_n"), ~replace_na(.x, 0)))

write_csv(assignments_outcomes,
          here("0-clean-data", "output", "stops-ba-joe.csv"))
```

